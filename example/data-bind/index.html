<!DOCTYPE html>
<html>

<head>
	<title>动态数据绑定</title>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
</head>
<style>

</style>

<body>

</body>
<script type="text/javascript">
	//实现一个事件
	function Event() {
		this.events = {};
	}
	// 事件添加绑定
	Event.prototype.on = function (attr, callback) {
		if (this.events[attr]) {
			this.events[attr].push(callback);
		} else {
			this.events[attr] = [callback];
		}
	}
	// 事件解除
	Event.prototype.off = function (attr) {
		for (let key in this.events) {
			if (this.events.hasOwnProperty(key) && key === attr) {
				delete this.events[key];
			}
		}
	}
	// 事件触发
	Event.prototype.emit = function (attr, ...arg) {
		this.events[attr] && this.events[attr].forEach(function (item) {
			item(...arg);
		})
	}
	// data-bind方法
	function Observer(data) {
		this.data = data;
		this.watch(data);
		this.eventwatch = new Event();
	}
	// 添加监听
	Observer.prototype.watch = function (obj) {
		let val;
		// 遍历对象各个属性为其绑定getter和setter
		for (let key in obj) {
			// for...in会把对象原型链上所有可枚举的属性循环出来，hasOwnProperty会筛选出对象本身拥有的属性
			if (obj.hasOwnProperty(key)) {
				val = obj[key];
				// 判断是否为对象
				if (typeof val === 'object') {
					new Observer(val);
				}
				this.setAndget(key, val);
			}
		}
	}
	// 添加监听set与get
	Observer.prototype.setAndget = function (key, val) {
		var _this = this;
		// 使用Object.defineProperty重新定义get和set方法
		Object.defineProperty(this.data, key, {
			enumerable: true,
			configurable: true,
			get: function () {
				if (typeof val === 'object') return val;
				console.log('你访问了' + key);
				return val
			},
			set: function (newval) {
				if (newval === val) return;
				console.log('你设置了' + key + '为' + JSON.stringify(newval));
				_this.eventwatch.emit(key, val, newval);
				val = newval;
				if (typeof newval === 'object') {
					new Observer(newval);
				}
			}
		})
	}
	// 添加set事件监听回调
	Observer.prototype.$watch = function (attr, callback) {
		this.eventwatch.on(attr, callback);
	}


	// 数据测试
	let data = {
		user: {
			name: "hp",
			age: "24",
			gender: "man"
		},
		address: "wuhan",
		book: ''
	};
	// new一个实例
	let app = new Observer(data);
	// 添加事件监听
	app.$watch('address', function (oldval, newval) {
		console.log(oldval + "更改为" + newval);
	})
	// 开始测试（后面注释为打印结果）
	data.user.age; //你访问了age
	data.user.name = '30'; //你设置了name为30
	data.user.gender; //你访问了gender
	data.book = {           //你设置了book为{"js":"javascript","css":"css3","html":"html5"}
		js: 'javascript',
		css: 'css3',
		html: 'html5'
	}
	data.book.js; //你访问了js
	data.book.js = 'es6' //你设置了js为"es6"
	data.address = 'hubei' //wuhan更改为hubei

</script>

</html>